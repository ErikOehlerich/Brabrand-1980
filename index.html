<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brabrand</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.2.0/src/L.Control.MousePosition.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.2.0/src/L.Control.MousePosition.css"/>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        #map { height: 100vh; width: 100vw; }
        .leaflet-control-geocoder {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var map = L.map('map', {
            center: [56.158, 10.139],
            zoom: 15,
            maxBounds: [[55.9, 9.9], [56.4, 10.4]], // Meget løsere bounds
            maxBoundsViscosity: 0.3 // Blødere grænser
        });

        // Base maps
        // OpenStreetMap Standard
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        });

        // ESRI Satellit kort
        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© ESRI',
            maxZoom: 19
        });

        // OpenTopoMap (topografisk kort)
        var topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenTopoMap',
            maxZoom: 17
        });

        // ESRI World Street Map
        var streets = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© ESRI',
            maxZoom: 19
        });

        // OpenStreetMap Humanitarian
        var humanitarian = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors, Humanitarian OpenStreetMap Team',
            maxZoom: 19
        });

        // CartoDB Dark Matter (mørkt tema)
        var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© CartoDB',
            maxZoom: 19
        });

        // Historiske kort som overlay (nu i mappen 1980)
        var historiskKort = L.tileLayer('./1980/{z}/{x}/{y}.png', {
            attribution: '© Erik Oehlerich',
            minZoom: 11,
            maxZoom: 17,
            tileSize: 256,
            opacity: 1.0,  // Fuld synlighed
            bounds: [[55.9, 9.9], [56.4, 10.4]], // Meget større område omkring Brabrand
            noWrap: true,
            errorTileUrl: '', // Skjul fejl-tiles
            updateWhenIdle: true
        });

        // Nyt historisk lag fra mappen 1953-1976
        var historiskKort1953 = L.tileLayer('./1953-1976/{z}/{x}/{y}.png', {
            attribution: '© Erik Oehlerich',
            minZoom: 11,
            maxZoom: 17,
            tileSize: 256,
            opacity: 1.0,
            bounds: [[55.9, 9.9], [56.4, 10.4]],
            noWrap: true,
            errorTileUrl: '',
            updateWhenIdle: true
        });

        // Definér base og overlay maps
        var baseMaps = {
            "OpenStreetMap": osm,
            "Satellit": satellite,
            "Topografisk": topo,
            "Vejkort": streets,
            "Humanitarian": humanitarian,
            "Mørkt tema": dark
        };

        // Opret koordinat-vælger gruppe
        var koordinatGruppe = L.layerGroup();
        
        // Marker og kontrol (ikke tilføjet til map før laget aktiveres)
        var marker = null;
        var koordinatInfo = L.control({position: 'topleft'});
        
        koordinatInfo.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'koordinat-info');
            // Minimal stil så boksen er lille og diskret
            this._div.style.background = 'rgba(255,255,255,0.95)';
            this._div.style.padding = '6px 8px';
            this._div.style.margin = '10px';
            this._div.style.border = '1px solid rgba(0,0,0,0.2)';
            this._div.style.borderRadius = '4px';
            this._div.style.fontSize = '13px';
            this._div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
            this._div.innerHTML = '<strong>Valgte koordinater</strong><br><span style="font-size:12px;color:#333">Klik på kortet for at vælge</span>';
            return this._div;
        };

        // Klik-handler: sæt markør, vis koordinater og kopier automatisk
        var clickHandler = function(e) {
            if (marker) {
                koordinatGruppe.removeLayer(marker);
            }
            marker = L.circleMarker(e.latlng, {
                radius: 6,
                color: '#d9534f',
                weight: 1,
                fillColor: '#d9534f',
                fillOpacity: 0.9
            });
            koordinatGruppe.addLayer(marker);

            var lat = e.latlng.lat.toFixed(6);
            var lng = e.latlng.lng.toFixed(6);
            var coords = lat + ', ' + lng;

            // Opdater kontrolboksen
            koordinatInfo._div.innerHTML = '<strong>Valgte koordinater</strong><br>' +
                                           '<div style="margin-top:4px;">Lat: ' + lat + '<br>Lng: ' + lng + '</div>' +
                                           '<div style="margin-top:6px;color:#2e7d32;font-weight:600;">Kopieret til udklipsholder</div>';

            // Kopier til udklipsholder (kræver HTTPS eller localhost)
            navigator.clipboard.writeText(coords).then(function() {
                // Vis kort bekræftelse i konsol (valgfrit)
                console.log('Koordinater kopieret: ' + coords);
            }).catch(function(err){
                console.warn('Kunne ikke kopiere koordinater:', err);
            });

            // Gør beskeden midlertidig (tilbage til instruks efter 2s)
            setTimeout(function() {
                if (koordinatInfo._div) {
                    koordinatInfo._div.innerHTML = '<strong>Valgte koordinater</strong><br><span style="font-size:12px;color:#333">Klik på kortet for at vælge</span>';
                }
            }, 2000);
        };

        // Håndter aktivering/deaktivering via layer-control
        map.on('overlayadd', function(e) {
            if (e.layer === koordinatGruppe) {
                // Vis kontrol og begynd lytte efter klik
                koordinatInfo.addTo(map);
                map.on('click', clickHandler);
            }
        });
        map.on('overlayremove', function(e) {
            if (e.layer === koordinatGruppe) {
                // Fjern kontrol og stop lytning; ryd markør
                koordinatInfo.remove();
                map.off('click', clickHandler);
                if (marker) {
                    koordinatGruppe.removeLayer(marker);
                    marker = null;
                }
            }
        });
        
        // Hvis brugeren vil have koordinatværktøjet aktivt ved load, kan man tilføje:
        // koordinatGruppe.addTo(map);
        // koordinatInfo.addTo(map);
        // map.on('click', clickHandler);

        // Opdateret overlay maps — begge historiske lag og koordinat-vælger
        var overlayMaps = {
            "Brabrand 1980-2001": historiskKort,
            "Brabrand 1953-1976": historiskKort1953,
            "Koordinat vælger": koordinatGruppe
        };

        // Tilføj layer control så menuen med kortlag vises
        var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);
 
        // Opacity-kontrol til historiske overlay (kompakt, foldbar)
        var opacityControl = L.control({ position: 'topright' });
        opacityControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'opacity-control');
            div.style.background = 'rgba(255,255,255,0.95)';
            div.style.padding = '4px';
            div.style.margin = '10px';
            div.style.border = '1px solid rgba(0,0,0,0.15)';
            div.style.borderRadius = '4px';
            div.style.fontSize = '12px';
            div.style.width = '140px';
            // foldbar header + skjult indhold
            div.innerHTML = '<div id="opacityHeader" style="cursor:pointer;font-weight:600;display:flex;justify-content:space-between;align-items:center;">' +
                            '<span>Historisk</span><span style="font-size:12px;" id="opacityToggleIcon">▾</span></div>' +
                            '<div id="opacityContent" style="display:block;margin-top:6px;">' +
                            '<div style="font-size:12px;margin-bottom:4px;">Opacity</div>' +
                            '<input id="overlayOpacity" type="range" min="0" max="100" value="100" style="width:120px;"><br>' +
                            '<div style="font-size:11px;margin-top:4px;"><span id="opacityVal">100%</span></div>' +
                            '</div>';
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        opacityControl.addTo(map);

        // fold/ud for opacity
        (function(){
            var hdr = document.getElementById('opacityHeader');
            var content = document.getElementById('opacityContent');
            var icon = document.getElementById('opacityToggleIcon');
            if (hdr && content && icon) {
                hdr.addEventListener('click', function(){
                    if (content.style.display === 'none') { content.style.display = 'block'; icon.textContent = '▾'; }
                    else { content.style.display = 'none'; icon.textContent = '▸'; }
                });
            }
        })();

        document.getElementById('overlayOpacity').addEventListener('input', function(e) {
            var p = parseInt(this.value, 10) / 100;
            document.getElementById('opacityVal').textContent = this.value + '%';
            if (historiskKort && typeof historiskKort.setOpacity === 'function') historiskKort.setOpacity(p);
            if (historiskKort1953 && typeof historiskKort1953.setOpacity === 'function') historiskKort1953.setOpacity(p);
        });

        // Opret lag til lokaliteter (så det kan toggles)
        var lokaliteterLayer = L.layerGroup();
        // Liste over alle markører (bruges til filtrering)
        var allMarkers = [];
        
        // Year-filter funktioner og UI (kompakt, foldbar)
        var yearFilterControl = L.control({ position: 'topright' });
        yearFilterControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'year-filter-control');
            div.style.background = 'rgba(255,255,255,0.95)';
            div.style.padding = '4px';
            div.style.margin = '10px';
            div.style.border = '1px solid rgba(0,0,0,0.15)';
            div.style.borderRadius = '4px';
            div.style.fontSize = '12px';
            div.style.width = '160px';
            div.innerHTML = '<div id="yearHeader" style="cursor:pointer;font-weight:600;display:flex;justify-content:space-between;align-items:center;">' +
                            '<span>Filter år</span><span style="font-size:12px;" id="yearToggleIcon">▾</span></div>' +
                            '<div id="yearContent" style="display:block;margin-top:6px;font-size:12px;">' +
                            '<div style="font-size:11px;margin-bottom:4px;">Fra: <span id="yrMinLbl">—</span> Til: <span id="yrMaxLbl">—</span></div>' +
                            '<input id="yrMin" type="range" min="1900" max="2100" value="1900" style="width:140px;"><br>' +
                            '<input id="yrMax" type="range" min="1900" max="2100" value="2100" style="width:140px;margin-top:6px;"><br>' +
                            '<label style="font-size:11px;margin-top:6px;display:block;"><input id="yrUnknown" type="checkbox" checked> Vis ukendte år</label>' +
                            '</div>';
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        yearFilterControl.addTo(map);

        // fold/ud for year filter
        (function(){
            var hdr = document.getElementById('yearHeader');
            var content = document.getElementById('yearContent');
            var icon = document.getElementById('yearToggleIcon');
            if (hdr && content && icon) {
                hdr.addEventListener('click', function(){
                    if (content.style.display === 'none') { content.style.display = 'block'; icon.textContent = '▾'; }
                    else { content.style.display = 'none'; icon.textContent = '▸'; }
                });
            }
        })();

        function applyYearFilter() {
            var min = parseInt(document.getElementById('yrMin').value, 10);
            var max = parseInt(document.getElementById('yrMax').value, 10);
            var showUnknown = document.getElementById('yrUnknown').checked;
            allMarkers.forEach(function(m) {
                var y = m._year;
                var inRange = false;
                if (isFinite(y)) inRange = (y >= min && y <= max);
                else inRange = showUnknown;

                // tilføj/fjern fra lokaliteterLayer
                if (inRange) {
                    if (!lokaliteterLayer.hasLayer(m)) lokaliteterLayer.addLayer(m);
                } else {
                    if (lokaliteterLayer.hasLayer(m)) lokaliteterLayer.removeLayer(m);
                }
            });
        }

        function updateYearFilterUI(min, max) {
            var minInput = document.getElementById('yrMin');
            var maxInput = document.getElementById('yrMax');
            var minLbl = document.getElementById('yrMinLbl');
            var maxLbl = document.getElementById('yrMaxLbl');
            if (!minInput || !maxInput) return;
            minInput.min = min;
            minInput.max = max;
            maxInput.min = min;
            maxInput.max = max;
            minInput.value = min;
            maxInput.value = max;
            minLbl.textContent = min;
            maxLbl.textContent = max;

            // events
            minInput.oninput = function() {
                var v = parseInt(this.value,10);
                if (v > parseInt(maxInput.value,10)) { this.value = maxInput.value; v = parseInt(this.value,10); }
                minLbl.textContent = v;
                applyYearFilter();
            };
            maxInput.oninput = function() {
                var v = parseInt(this.value,10);
                if (v < parseInt(minInput.value,10)) { this.value = minInput.value; v = parseInt(this.value,10); }
                maxLbl.textContent = v;
                applyYearFilter();
            };
            var unk = document.getElementById('yrUnknown');
            unk.onchange = applyYearFilter;
        }

        // Funktion: indlæs Excel (xlsx) fra en sti og tilføj punkter til lokaliteterLayer
        function loadExcelToMap(path) {
            console.log('Forsøger at indlæse Excel fra:', path);
            fetch(encodeURI(path)).then(function(resp) {
                console.log('Fetch response:', resp.status, resp.statusText);
                if (!resp.ok) throw new Error('Fetch fejlede: ' + resp.status + ' ' + resp.statusText);
                return resp.arrayBuffer();
            }).then(function(ab) {
                var workbook;
                try {
                    workbook = XLSX.read(ab, {type: 'array'});
                } catch (err) {
                    console.error('XLSX.read fejlede:', err);
                    // Prøv fallback som binary string
                    try {
                        var s = new Uint8Array(ab);
                        var binary = Array.prototype.map.call(s, function(ch){ return String.fromCharCode(ch); }).join('');
                        workbook = XLSX.read(binary, {type: 'binary'});
                        console.warn('Brugte binary-fallback til at læse workbook');
                    } catch (err2) {
                        throw err2;
                    }
                }

                console.log('Workbook sheets:', workbook.SheetNames);
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var rows = XLSX.utils.sheet_to_json(worksheet, {defval: ''});

                console.log('Excel rækker (parsed):', rows.length);
                if (rows.length === 0) {
                    console.warn('Ingen rækker fundet i arket:', firstSheetName, '-- tjek kolonneoverskrifter.');
                }

                var added = 0;
                rows.forEach(function(row, i) {
                    if (i < 3) console.log('Række', i, row); // vis et par rækker til debugging

                    var projekt = row['Projekt'] || row['Project'] || row['projekt'] || '';
                    var adresse = row['Adresse'] || row['Address'] || row['adresse'] || '';
                    var årstal = row['Årstal'] || row['Aarstal'] || row['År'] || row['Year'] || '';
                    var typeByg = row['Type af byggeri'] || row['Type'] || row['type'] || '';
                    var note = row['Note'] || row['Bemærkning'] || row['Note/Comment'] || '';

                    var lat = null, lng = null;
                    // Støt flere formater: separate kolonner, "lat,lng", semikolon, komma decimal mv.
                    function parseNumber(v) {
                        if (v === null || v === undefined) return NaN;
                        var s = String(v).trim();
                        if (s === '') return NaN;
                        s = s.replace(',', '.'); // decimalkomma -> punktum
                        return parseFloat(s);
                    }

                    if (row['Lat'] !== undefined && row['Lng'] !== undefined) {
                        lat = parseNumber(row['Lat']);
                        lng = parseNumber(row['Lng']);
                    } else if (row['Latitude'] !== undefined && row['Longitude'] !== undefined) {
                        lat = parseNumber(row['Latitude']);
                        lng = parseNumber(row['Longitude']);
                    } else if (row['Koordinater'] || row['Koordinat'] || row['Coordinates']) {
                        var coordStr = (row['Koordinater'] || row['Koordinat'] || row['Coordinates']).toString();
                        // accepter "lat, lng", "lng;lat" osv.
                        var m = coordStr.match(/[-+]?\d+[.,]?\d*/g);
                        if (m && m.length >= 2) {
                            var a = parseNumber(m[0]);
                            var b = parseNumber(m[1]);
                            // best guess: hvis første værdi > 90 antag lng,lat byttet
                            if (Math.abs(a) > 90 && Math.abs(b) <= 90) {
                                lng = a; lat = b;
                            } else {
                                lat = a; lng = b;
                            }
                        }
                    }

                    // ekstra: prøv felter med semikolon eller space-separeret
                    if ((!isFinite(lat) || !isFinite(lng)) && (row['Coord'] || row['coord'])) {
                        var c = (row['Coord'] || row['coord']).toString().match(/[-+]?\d+[.,]?\d*/g);
                        if (c && c.length >= 2) { lat = parseNumber(c[0]); lng = parseNumber(c[1]); }
                    }

                    if (!isFinite(lat) || !isFinite(lng)) {
                        console.warn('Ugyldige koordinater for række (springes over):', row);
                        return;
                    }

                    // Hvis lat/lng byttet (fx lat > 90), prøv at byt
                    if (Math.abs(lat) > 90 && Math.abs(lng) <= 90) {
                        console.warn('Ser ud som byttede koordinater, bytter automatisk for række:', row);
                        var tmp = lat; lat = lng; lng = tmp;
                    }

                    var marker = L.circleMarker([lat, lng], {
                        radius: 6,
                        color: '#B22222',
                        weight: 1,
                        fillColor: '#B22222',
                        fillOpacity: 0.9
                    });

                    // Gem koordinater som skjult data på markøren (ikke vist i popup)
                    marker._coords = { lat: lat, lng: lng };
                    // Gem årstal på markøren (nummer eller NaN)
                    var yearNum = parseInt(String(årstal).replace(/[^\d\-]/g, ''), 10);
                    marker._year = isFinite(yearNum) ? yearNum : NaN;
                    // Gem øvrige felter (kan bruges senere)
                    marker._meta = { projekt: projekt, adresse: adresse, type: typeByg, note: note };

                    var popup = '<div style="max-width:260px;font-size:14px;line-height:1.3;">' +
                                (projekt ? '<div><strong>Projekt:</strong> ' + projekt + '</div>' : '') +
                                (adresse ? '<div><strong>Adresse:</strong> ' + adresse + '</div>' : '') +
                                (årstal ? '<div><strong>Årstal:</strong> ' + årstal + '</div>' : '') +
                                (typeByg ? '<div><strong>Type:</strong> ' + typeByg + '</div>' : '') +
                                (note ? '<div><strong>Note:</strong> <em>' + note + '</em></div>' : '') +
                                '</div>';
 
                    marker.bindPopup(popup);
                    // Gem i master-listen og i layeret (initialt synligt)
                    allMarkers.push(marker);
                    lokaliteterLayer.addLayer(marker);
                    added++;
                });
 
                // Tilføj overlay én gang
                try { layerControl.addOverlay(lokaliteterLayer, 'Lokaliteter (Excel)'); } catch(e){}
 
                console.log('Markers tilføjet fra Excel:', added);
                // Opsæt år-slider hvis vi har årstal
                var years = allMarkers.map(function(m){ return m._year; }).filter(isFinite);
                if (years.length > 0) {
                    var minY = Math.min.apply(null, years);
                    var maxY = Math.max.apply(null, years);
                    // Start sliderens mindste værdi ved 1900 så kortet kan være blankt til 1900
                    var startMin = 1900;
                    updateYearFilterUI(startMin, maxY);
                     // initial filter (vis alle mellem min og max)
                     applyYearFilter();
                } else {
                    // Hvis ingen årstal, skjul år-filter label
                    document.getElementById('yrMinLbl').textContent = '—';
                    document.getElementById('yrMaxLbl').textContent = '—';
                }
                 if (added > 0) lokaliteterLayer.addTo(map);
                 else console.warn('Ingen gyldige punkter fundet i Excel-filen.');
             }).catch(function(err){
                 console.error('Kunne ikke indlæse eller parse Excel:', err);
             });
         }

        // Indlæs din fil fra mappen "excel"
        loadExcelToMap('./excel/FM.xlsx');

        // Start med OSM som baggrund og historisk kort som overlay
        osm.addTo(map);
        historiskKort.addTo(map);

        // Det manuelle skolepunkt er fjernet (marker oprettes nu kun fra Excel-data)
        // Tilføj søgefunktion
        var geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            position: 'topleft',
            placeholder: 'Søg efter adresse...',
            geocoder: new L.Control.Geocoder.Nominatim({
                language: 'da' // Dansk sprog
            })
        }).addTo(map);

        // Håndter søgeresultater
        geocoder.on('markgeocode', function(e) {
            var bbox = e.geocode.bbox;
            var poly = L.polygon([
                bbox.getSouthEast(),
                bbox.getNorthEast(),
                bbox.getNorthWest(),
                bbox.getSouthWest()
            ]);
            map.fitBounds(poly.getBounds());
        });
    </script>
</body>
</html>